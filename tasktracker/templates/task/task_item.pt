<metal:macro metal:define-macro="show_task">

<tr tal:attributes="parentID atask/parentID; id string:task_${atask/id}; task_id atask/id; sort_index atask/sort_index;
    owner atask/owner; deadline atask/deadline; priority atask/priority; status atask/status; updated atask/updated;
    is_preview python: test(exists('is_preview'), 'True', 'False'); no_second_row python: test(exists('no_second_row'), 'True', 'False');
    is_flat python: test(exists('flat'), 'True', 'False');
    class python: '%s taskrow task-item' % test(h.has_permission('task', 'update', id=atask.id), 'deletable', 'nondeletable');">

<td class="title-column">
<span tal:attributes="id string:draggable_${atask/id}; depth python: atask.depth() - c.depth" class="taskitem draggable">

      <span tal:condition="not:exists:flat"
	tal:replace="structure python: h.image_tag(test(atask.liveChildren(), 'plus.png', 'blank.png'),
		class_='treewidget handle',
		id='handle_%d' % atask.id,
		style='margin-left: %dpx;' % ((atask.depth() - c.depth) * 15))" />

  <!-- title -->
<metal:macro define-slot="task_title">

  <span tal:condition="exists:editableTitle" tal:content="structure python:h.editableField(atask, 'title')"
            tal:attributes="class python: 'task_item %s %s' % (test(atask.status=='done', 'completed-task',
	         test(h.isOverdue(atask.deadline), 'overdue-task', 'uncompleted-task')),
		 test(atask.parentID == 0, 'root-task', 'sub-task'));"/>

  <a tal:condition="not:exists:editableTitle" tal:content="python: h.previewText(atask.title, 20)" 
     tal:attributes="href python:h.url_for(controller='task', action='show', id=atask.id);
     title atask/text;
     class python:'task_item %s %s%s' % (test(atask.status=='done', 'completed-task',
     	   	   	      	      	      test(h.isOverdue(atask.deadline), 'overdue-task', 'uncompleted-task')),
					 test(atask.parentID == 0, 'root-task', 'sub-task'),
					 test(exists('is_preview'), ' preview-link', ''));
     id string:title_${atask/id}" />

</metal:macro>

  <span tal:condition="atask/uncompletedChildren" class="small" tal:content="python:'(%d tasks left)' % len(atask.uncompletedChildren())" />
  <span tal:condition="atask/comments" tal:replace="python:'%d comments' % len(atask.comments)" />
  <span tal:condition="atask/private" tal:replace="string: -- (private)" />
</span>

 <div tal:condition="not:exists:no_second_row" class="second-line">
  <span tal:attributes="style python:'clear:both;; margin-left: %dpx;;' % ((atask.depth() - c.depth) * 15 + 25);">
    &nbsp;
    <span tal:replace="python:h.previewText(atask.text, c.previewTextLength)"/>
  </span></div>

</td>


<td class="status-column">
 <span tal:replace="structure python:h.editableField(atask, 'status')"/>
 <div tal:condition="not:exists:no_second_row" class="second-line">&nbsp;</div>
</td>

<td class="deadline-column" tal:condition="python: atask.task_list.hasFeature('deadlines')">
 <span tal:replace="structure python:h.editableField(atask, 'deadline')"/>
   <div tal:condition="not:exists:no_second_row" class="second-line">&nbsp;</div>
</td>


<td class="priority-column">
 <span tal:replace="structure python:h.editableField(atask, 'priority')"/>
 <div tal:condition="not:exists:no_second_row" class="second-line">&nbsp;</div>
</td>

<td class="owner-column">
 <span tal:replace="structure python:h.editableField(atask, 'owner')"/>
 <div tal:condition="not:exists:no_second_row" class="second-line">&nbsp;</div>
</td>

<td class="updated-column">
 <span tal:replace="structure python: h.readableDate(atask.updated)"/>
 <div tal:condition="not:exists:no_second_row" class="second-line">&nbsp;</div>
</td>

</tr>

</metal:macro>
