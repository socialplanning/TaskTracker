<metal:macro metal:define-macro="show_task">

<tr tal:attributes="parentID atask/parentID; id string:task_${atask/id}; task_id atask/id; sort_index atask/sort_index;
    owner atask/owner; deadline atask/deadline; priority atask/priority; status atask/status;
    class python: '%s taskrow task-item' % test(h.has_permission('task', 'update', id=atask.id), 'deletable', 'nondeletable');">

<td>
<span tal:attributes="id string:draggable_${atask/id}; depth python: atask.depth() - c.depth" class="taskitem draggable">

  <span tal:condition="not: c/flat"
	tal:replace="structure python: h.image_tag(test(atask.liveChildren(), 'plus.png', 'blank.png'),
		class_='treewidget handle',
		id='handle_%d' % atask.id,
		style='margin-left: %dpx;' % ((atask.depth() - c.depth) * 15))" />

  <!-- title -->
  <a tal:content="python: h.previewText(atask.title, 20)" 
     tal:attributes="href python:h.url_for(controller='task', action='show', id=atask.id);
     title atask/text;
     class python: 'task_item %s %s' % (test(atask.status=='done', 'completed-task',
     test(h.isOverdue(atask.deadline), 'overdue-task', 'uncompleted-task')),
     test(atask.parentID == 0, 'root-task', 'sub-task'));
     id string:title_${atask/id}" />

  <span tal:condition="atask/uncompletedChildren" tal:replace="python:'(%d tasks left)' % len(atask.uncompletedChildren())" />
  <span tal:condition="atask/comments" tal:replace="python:'%d comments' % len(atask.comments)" />
  <span tal:condition="atask/private" tal:replace="string: -- (private)" />

  <p tal:attributes="style python:'clear:both;; margin-left: %dpx;;' % ((atask.depth() - c.depth) * 15 + 25);">
    &nbsp;<span tal:replace="python:h.previewText(atask.text, c.previewTextLength)"/>
  </p>
</span>
</td>

<!-- <form tal:attributes="action string:/task/update/${atask/id}"> -->

<td width="15%">
 <span tal:replace="structure python:h.editableField(atask, 'status')"/>
</td>

<td width="15%">
 <span tal:replace="structure python:h.editableField(atask, 'deadline')"/>
</td>

<td width="15%">
 <span tal:replace="structure python:h.editableField(atask, 'priority')"/>
</td>

<td width="15%">
 <span tal:replace="structure python:h.editableField(atask, 'owner')"/>
</td>

</tr>
<span metal:define-slot="post_task" />
</metal:macro>
