<metal:macro metal:define-macro="show_task">

<li tal:attributes="id string:task_${atask/id}; task_id atask/id; style string:line-height: 2em;;; sort_index atask/sort_index; owner atask/owner; deadline atask/deadline; priority python: h.priority_as_int(atask.priority); status atask/status; class python: test(h.has_permission('task', 'update', id=atask.id), 'deletable', 'nondeletable');">

<span tal:attributes="style python:'padding-left: %dpx;;' % ((atask.depth() - c.depth) * 15); depth python: atask.depth() - c.depth" class="taskitem">

    <span tal:replace="structure python: h.image_tag(test(atask.liveChildren(), 'plus.png', 'blank.png'), class_='treewidget', id='collapseButton_%d' % atask.id)" />

    <span tal:attributes="id string:draggable_${atask/id};">
        <span tal:replace="structure python: h.image_tag(test(atask.liveChildren(), '/images/folder_open.png', '/images/file.png'), id = 'handle_%s' % atask.id, onclick = 'toggleCollapse(%s)' % atask.id, class_='handle')" />

        <!-- title -->
        <a tal:content="atask/title" tal:attributes="href python:h.url_for(controller='task', action='show', id=atask.id); title atask/text; class python: '%s %s' % (test(atask.status=='done', 'completed-task', 'uncompleted-task'), test(atask.parentID == 0, 'root-task', 'sub-task')); id string:title_${atask/id}" />        <span tal:condition="atask/private" tal:attributes="style string: color:red" tal:content="string: -- (private)" />
    </span>
</span>

<!-- the status -->

<span class="status-column" tal:condition="python: h.has_permission('task', 'change_status', id=atask.id)" 
tal:content="structure python: 
h.select('status', 
         h.options_for_select([(s.name, s.name) for s in c.tasklist.project.statuses], 
                              atask.status), 
         method='post', 
         originalvalue='%s' % [s.name for s in c.tasklist.project.statuses].index(atask.status),
         onchange='changeField(&quot;%s&quot;,%d, &quot;status&quot;)' % (h.url_for(controller='task',
                                                                 action='change_status',
                                                                 id=atask.id),
                                                       atask.id),
                   id='status_%d' % atask.id) "
tal:attributes="id string:status-form_${atask/id};"/>

<span class="status-column" tal:attributes="style python: test(h.has_permission('task', 'change_status', id=atask.id), 'display:none;;', ''); id string:label_${atask/id}; " tal:content="atask/status" />

<span tal:replace="structure python: h.end_form()" />

<!-- end status -->

<!-- deadline -->

<span class="deadline-column" tal:content="python: h.readableDate(atask.deadline)" />

<!-- priority -->

<span class="priority-column" tal:condition="python: h.has_permission('task', 'change_priority', id=atask.id)" 
tal:content="structure python:
h.select('priority',
         h.options_for_select([(s, s) for s in 'High Medium Low None'.split()], 
                              atask.priority),
         method='post',
         originalvalue=atask.priority,
         onchange='changeField(&quot;%s&quot;,%d, &quot;priority&quot;)' % (h.url_for(controller='task',
                                                                 	 action='change_priority',
                                                                 	 id=atask.id),
                                                       			 atask.id),
                   id='priority_%d' % atask.id) "
tal:attributes="id string:priority-form_${atask/id};"/>

<span class="priority-column" tal:attributes="style python: test(h.has_permission('task', 'change_priority', id=atask.id), 'display:none;;', ''); id string:label_${atask/id}; " tal:content="atask/priority" />

<span tal:replace="structure python: h.end_form()" />
<!--span class="priority-column" tal:content="atask/priority" /-->

<!-- owner -->

<span class="assigned-column" tal:content="python:test(atask.owner, atask.owner, 'unassigned')" />

<!-- creator -->
<span class="creator-column" tal:content="atask/creator" />

<!-- subtasks -->

<ul id="xtasks" class="task_list">
<tal:for repeat="atask atask/liveChildren">

<metal:do metal:use-macro="here/task_item/macros/show_task" />

</tal:for>
</ul>

</li>
</metal:macro>
