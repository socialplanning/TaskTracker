<hr/><br/>
<span class="small">
<a tal:attributes="href python:h.url_for(controller='tasklist', action='show', id=c.task.task_list.id)">
&lt;&lt; return to tasklist</a>&nbsp;

<a tal:attributes="href python:h.url_for(controller='tasklist', action='index')">
&lt;&lt; return to list of lists</a>
</span><br/>

<metal:do use-macro="here/task_list_title/macros/show_title"/>

<br/><br/>

<table tal:condition="c/task/previousTask" tal:define="atask c/task/previousTask" class="task_list preview" width="100%">
 <metal:do metal:use-macro="here/task_item/macros/show_task">
  <metal:slot fill-slot="task_title">
   <a tal:content="python: h.previewText(atask.title, 20)" 
      tal:attributes="href python:h.url_for(controller='task', action='show', id=atask.id);
      title atask/text;
      class python: 'preview-link task_item %s %s' % (test(atask.status=='done', 'completed-task',
      test(h.isOverdue(atask.deadline), 'overdue-task', 'uncompleted-task')),
      test(atask.parentID == 0, 'root-task', 'sub-task'));
      id string:title_${atask/id}" />
  </metal:slot>
 </metal:do>
</table>

<div id="wrap-task-details">

<table class="task_list" tal:define="atask c/task" width="100%" >
  <metal:do metal:use-macro="here/task_item/macros/show_task">
    <metal:slot fill-slot="task_title">
      <span tal:content="structure python:h.editableField(atask, 'title')"
            tal:attributes="class python: 'task_item %s %s' % (test(atask.status=='done', 'completed-task',
	         test(h.isOverdue(atask.deadline), 'overdue-task', 'uncompleted-task')),
		 test(atask.parentID == 0, 'root-task', 'sub-task'));"/>
    </metal:slot>
  </metal:do>
</table>

<table id="activity-table">
 <tr>
  <td class="small task-detail-mainbar">

   <span tal:replace="structure python:h.editableField(c.task, 'text')"/>
   <br/>
   <b tal:condition="python: h.field_last_updated(c.task, 'text')"
      id="description_updated">
      Description last updated 
      <span tal:replace="structure python: h.field_last_updated(c.task, 'text')"/>
   </b>
   <b tal:condition="python: not h.field_last_updated(c.task, 'text')"
      id="description_updated">Description never updated
   </b>
   <hr/>

   <b>Latest activity:</b>
  </td>
  <td>&nbsp;</td>
 </tr>
 <tr>
  <td class="small task-detail-mainbar">
   <ul id="activity">
    <tal:nada repeat="action python: h.preview_list(c.task.actions())">
     <span tal:replace="structure python: h.render_action(action)"/>
     <hr/>
    </tal:nada>
   </ul>
  </td>
  <td id="task-detail-sidebar-cell">
   <div id="task-detail-sidebar" class="small">
    Task created by <span tal:replace="c/task/creator"/>
    <span tal:replace="structure python:h.prettyDate(c.task.created)"/>
   </div>
  </td>
 </tr>

 <tr>
  <td class="task-detail-mainbar">
   <hr/>
  </td>
 </tr>
</table>



<span tal:condition="python: h.has_permission(controller='task', action='update_private', id=c.task.id)"  id="private">
<metal:do use-macro="here/_private/macros/private"/>
</span>

<tal:if condition="python: h.has_permission(controller='task', action='comment', id=c.task.id)">

<span id="comment" class="unfolded command">add comment</span>&nbsp;&nbsp;
<div id="edit_comment" class="folded">

<form tal:attributes="action python:h.url_for(action='comment', task_id=c.task.id)" id="add_comment_form" method="post">

<label for="text">Comment:<label><br/>
 <textarea name="text" cols=80 rows=10></textarea><br/>

<input type="submit" value="comment" name="comment">
</form>
</div>
</tal:if>

<tal:if condition="python: h.has_permission(controller='task', action='update', id=c.task.id)">
<span tal:replace="structure python: h.link_to('delete this task',
   confirm='Are you sure you want to delete this task', url=h.url_for(controller='task', action='destroy', id=c.task.id))"/>
</tal:if>

<metal:do use-macro="here/_hideable_show_create/macros/show">
<a metal:fill-slot="subtask_link" tal:attributes="href python:h.url_for(action='show_create', controller='task', task_listID=c.tasklist.id, parentID=c.task.id)" onclick="showTaskCreate();return false;">[ + ] add a sub-task</a>
<metal:macro fill-slot="parentID">
<input type="hidden" name="parentID" tal:attributes="value c/task/id" />
</metal:macro>

</metal:do>

<br/><br/>

<span tal:attributes="style python: test(len(c.task.liveChildren()), '', 'display:none;;')" class="unfolded" id="subtasks">
This task has <span tal:content="python: len(c.task.liveDescendents())" class="num_subtasks"/> sub-tasks.
<span class="command">View them.</span><br/>

<span class="folded" id="edit_subtasks">
<span class="command" onclick="$('edit_subtasks').hide(); $('subtasks').show();">
hide <span tal:replace="python: len(c.task.liveDescendents())" class="num_subtasks"/> sub-tasks
</span>

<table width="100%" id="tasks" class="all_tasks">
  <tal:for repeat="atask c/task/liveChildren">
    <metal:do metal:use-macro="here/task_list_item/macros/show_task" />
  </tal:for>
</table>

<br/>
<hr/>
</span>
</span>

</div>

<br/>

<table tal:condition="c/task/nextTask" tal:define="atask c/task/nextTask" class="task_list preview" width="100%">
 <metal:do metal:use-macro="here/task_item/macros/show_task">
  <metal:slot fill-slot="task_title">
   <a tal:content="python: h.previewText(atask.title, 20)" 
      tal:attributes="href python:h.url_for(controller='task', action='show', id=atask.id);
      title atask/text;
      class python: 'preview-link task_item %s %s' % (test(atask.status=='done', 'completed-task',
      test(h.isOverdue(atask.deadline), 'overdue-task', 'uncompleted-task')),
      test(atask.parentID == 0, 'root-task', 'sub-task'));
      id string:title_${atask/id}" />
  </metal:slot>
 </metal:do>
</table>

<metal:do metal:use-macro="here/task_list_footer/macros/show_footer">
<span metal:fill-slot="pre_footer"> <a tal:attributes="href python:h.url_for(action='show', controller='tasklist', id=c.task.task_listID)">Go back to the task list</a> | </span>
</metal:do>

<span id="post_add_task" func="count_subtasks"></span>

<span id="post_edit_task" func="change_description_updated"></span>

<script>
function change_description_updated(task_id, field_name) {
    if (field_name == 'text') {
        $('description_updated').innerHTML = "Description last updated Today by you";
    }

    var b = Builder.node('b', field_name + " updated Today by you");
    var li = Builder.node('li', {}, [b]);
    $('activity').appendChild(li);

}

function count_subtasks() {

with_items ("num_subtasks", function(node) { node.innerHTML = parseInt(node.innerHTML) + 1;; }, document.childNodes[0]); 

$('subtasks').show();

}
</script>
